(function(){var x=0,u={},y=/\r/g,p=function(a){var b,c;if((b=t[a.type]||t[a.nodeName.toLowerCase()])&&void 0!==(c=b(a,"value")))return c;c=a.value;return"string"===typeof c?c.replace(y,""):null==c?"":c},t={option:function(a){var b=a.getAttribute("value");return null!=b?b:h(a.innerText||a.textContent)},select:function(a){for(var b,c=a.options,d=a.selectedIndex,g=(a="select-one"===a.type||0>d)?null:[],f=a?d+1:c.length,e,h=0>d?f:a?d:0;h<f;h++)if(b=c[h],e=b.disabled||null!==b.getAttribute("disabled")||
c.parentNode.disabled,(b.selected||h===d)&&!e){b=p(b);if(a)return b;g.push(b)}return g}};t.radio=t.checkbox=function(a){return null===a.getAttribute("value")?"on":a.value};var e=Array.prototype.slice,f=function(){for(var a=e.call(arguments),b=a.shift(),c,d;a.length;)if(c=a.shift())for(d in c)c.hasOwnProperty(d)&&(b[d]&&"object"==typeof b[d]&&"object"==typeof c[d]?f(b[d],c[d]):b[d]=c[d]);return b},h=function(){return String.prototype.trim?function(a){return"string"==typeof a?a.trim():a}:function(a){return"string"==
typeof a?a.replace(/^\s\s*/,"").replace(/\s\s*$/,""):a}}(),l=Function.prototype.bind?function(a,b){return a.bind(b)}:function(a,b){return function(){a.apply(b,arguments)}},n=function(a,b,c){a.attachEvent?a.attachEvent("on"+b,c):a.addEventListener(b,c,!1)},C=function(a,b,c){a.detachEvent?a.detachEvent("on"+b,c):a.removeEventListener(b,c,!1)},D={},E=function(a){return D[a]||(D[a]=new RegExp("(?:^|\\s)"+a+"(?!\\S)","g"))},z=function(a,b){return E(b).test(a.className)},r=function(a,b){z(a,b)||(a.className+=
" "+b)},q=function(a,b){var c=E(b);a.className=a.className.replace(c,"")},v=function(a,b,c){var d,g=a.childNodes;if(!1!==b.call(c,a))for(a=-1,d=g.length>>>0;++a!==d;v(g[a],b,c));},A=MetaphorJs.lib.Observable,w=function(a,b){var c=0;switch(b.nodeName.toLowerCase()){case "select":return v(b,function(a){a.selected&&c++}),c;case "input":if(/radio|checkbox/i.test(b.type))return v(b.form,function(a){a.type==b.type&&a.name==b.name&&a.checked&&c++}),c}return a.length},k=function(a,b){if(!b)return void 0===
a||""===a||null===a;switch(b.nodeName.toLowerCase()){case "select":var c=p(b);return!c||0==c.length;case "input":if(/radio|checkbox/i.test(b.type))return 0==w(a,b)}return 0==h(a).length},B=function(a,b){if("function"==typeof b)return a;b&&"object"==typeof b&&"number"==typeof b.length&&"[object Array]"==Object.prototype.toString.call(b)||(b=[b]);var c,d=b.length;for(c=-1;++c<d;a=a.replace(new RegExp("\\{"+c+"\\}","g"),b[c]));return a},F=function(a){var b=a.nodeName.toLowerCase();a=a.type;return"input"!=
b&&"textarea"!=b&&"select"!=b||"submit"==a||"reset"==a?!1:!0},s={};f(s,{required:function(a,b,c){return!1===c?!0:!k(a,b)},regexp:function(a,b,c){c=c instanceof RegExp?c:new RegExp(c);return k(a,b)||c.test(a)},notregexp:function(a,b,c){c=c instanceof RegExp?c:new RegExp(c);return k(a,b)||!c.test(a)},minlength:function(a,b,c){return k(a,b)||(b?w(h(a),b)>=c:a.toString().length>=c)},maxlength:function(a,b,c){return k(a,b)||(b?w(h(a),b)<=c:a.toString().length<=c)},rangelength:function(a,b,c){var d=b?w(h(a),
b):a.toString().length;return k(a,b)||d>=c[0]&&d<=c[1]},min:function(a,b,c){return k(a,b)||parseInt(a,10)>=c},max:function(a,b,c){return k(a,b)||parseInt(a,10)<=c},range:function(a,b,c){a=parseInt(a,10);return k(a,b)||a>=c[0]&&a<=c[1]},email:function(a,b){return k(a,b)||/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i.test(a)},
url:function(a,b){return k(a,b)||/^((https?|ftp):\/\/|)(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(a)},
date:function(a,b){return k(a,b)||!/Invalid|NaN/.test(new Date(a))},dateiso:function(a,b){return k(a,b)||/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(a)},number:function(a,b){return k(a,b)||/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test(a)},digits:function(a,b){return k(a,b)||/^\d+$/.test(a)},creditcard:function(a,b){if(k(a,b))return!0;if(/[^0-9-]+/.test(a))return!1;var c=0,d=!1,g;a=a.replace(/\D/g,"");for(var f=a.length-1;0<=f;f--)g=a.charAt(f),g=parseInt(g,10),d&&9<(g*=2)&&(g-=9),c+=g,d=!d;return 0==
c%10},accept:function(a,b,c){c="string"==typeof c?c.replace(/,/g,"|"):"png|jpe?g|gif";return k(a,b)||a.match(new RegExp(".("+c+")$","i"))},equalto:function(a,b,c,d){c=(b=d.getValidator().getField(c))?b.getElem():c;return a==p(c)},notequalto:function(a,b,c,d){c=(b=d.getValidator().getField(c))?b.getElem():c;return a!=p(c)},zxcvbn:function(a,b,c){return zxcvbn(a).score>=parseInt(c)}});var G={required:"This field is required.",remote:"Please fix this field.",email:"Please enter a valid email address.",
url:"Please enter a valid URL.",date:"Please enter a valid date.",dateISO:"Please enter a valid date (ISO).",number:"Please enter a valid number.",digits:"Please enter only digits.",creditcard:"Please enter a valid credit card number.",equalTo:"Please enter the same value again.",accept:"Please enter a value with a valid extension.",maxlength:"Please enter no more than {0} characters.",minlength:"Please enter at least {0} characters.",rangelength:"Please enter a value between {0} and {1} characters long.",
range:"Please enter a value between {0} and {1}.",max:"Please enter a value less than or equal to {0}.",min:"Please enter a value greater than or equal to {0}."},K={allowSubmit:!0,alwaysCheck:!1,alwaysDisplayState:!1,data:null,ignore:null,disabled:!1,cls:{valid:"",error:"",ajax:""},errorBox:{cls:"",fn:null,tag:"",position:"after",elem:null,enabled:!0},callback:{scope:null,destroy:null,statechange:null,errorchange:null,submit:null,check:null,beforeAjax:null,afterAjax:null,displaystate:null},rules:{},
messages:{}},H=function(a){if(!a)return{};var b=function(b,d,g){var f=a[b],e=!1;if(void 0!==f){switch(g){case "string":e="string"==typeof f;break;case "function":e="function"==typeof f;break;case "boolean":if(!0===f||!1===f)e=!0}e&&(a[b]={},a[b][d]=f)}};b("errorBox","enabled","boolean");b("errorBox","tag","string");b("errorBox","fn","function");return a},I=function(a,b,c){b=b||{};var d,g;this._observable=new A;f(this,this._observable.getApi());this.cfg=d=f({},K,H(m.fieldDefaults),H(b));var e=(a.type||
"").toLowerCase();this.elem=a;this.vldr=c;this.callbackScope=g=d.callback.scope;this.inputType=e;this.enabled=null===a.getAttribute("disabled");this.id=a.getAttribute("name")||a.getAttribute.attr("id");this.isField=F(a);this.checkbox="checkbox"==e;this.radio="radio"==e;this.phldr=a.getAttribute("placeholder");var e=a.nodeName.toLowerCase(),h=a.type?a.type.toLowerCase():"";this.submittable="input"==e&&"radio"!=h&&"checkbox"!=h;this.data=b.data;this.rules={};d.messages=f({},G,m.messages,d.messages);
a.setAttribute("data-validator",c.getVldId());this.radio&&this.initRadio();this.onChangeDelegate=l(this.onChange,this);for(var k in d.callback)if(d.callback[k])this.on(k,d.callback[k],g);d.rules&&this.setRules(d.rules,!1);this.readRules();this.setEvents("bind");this.prev=this.getValue();d.disabled&&this.disable()};f(I.prototype,{vldr:null,elem:null,rules:null,cfg:null,callbackScope:null,inputType:null,enabled:!0,valid:null,dirty:!1,id:null,prev:"",error:null,errorRule:null,pending:null,isField:!0,
checkbox:!1,radio:!1,radios:null,rulesNum:0,phldr:null,submittable:!1,displayState:!1,data:null,lastEvent:null,processingEvent:!1,checking:!1,checkTmt:null,errorBox:null,customError:!1,getValidator:function(){return this.vldr},initRadio:function(){var a=this.elem,b=a.getAttribute("name"),c=this.vldr.getElem(),d;c.querySelectorAll?d=c.querySelectorAll("input[type=radio][name="+b+"]"):(d=[],v(a,function(a){"input"==a.nodeName.toLowerCase()&&"radio"==a.type&&a.getAttribute("name")==b&&d.push(a)}));a=
0;for(c=d.length;a<c;a++)d[a].setAttribute("data-validator","");this.radios=d},setRules:function(a,b){b=void 0==b?!0:b;for(var c in a)this.setRule(c,a[c],!1);b?this.check(!1):this.setValidState(null);return this},setRule:function(a,b,c){var d=this.rules;c=void 0==c?!0:c;null===b?(d[a]&&this.rulesNum--,delete d[a]):(d[a]||this.rulesNum++,d[a]=b,null!==this.valid&&this.setValidState(!1));c?this.check(!1):this.setValidState(null);return this},setMessage:function(a,b){this.cfg.messages[a]=b;return this},
setMessages:function(a){for(var b in a)this.setMessage(b,a[b]);return this},getMessages:function(){return f({},this.cfg.messages)},readRules:function(){var a=this.elem,b=a.className,c={},d,g;for(g in s)s.hasOwnProperty(g)&&(d=a.getAttribute(g)||a.getAttribute("data-validate-"+g),null!==d&&void 0!=d&&!1!==d&&("minlength"!=g&&"maxlength"!=g||-1!=parseInt(d,10))&&(c[g]=d,(d=a.getAttribute("data-message-"+g))&&this.setMessage(g,d)));if(d=a.getAttribute("remote"))c.remote=d;if(b)for(b=b.split(" "),g=0,
d=b.length;g<d;g++)if(a=h(b[g]),s[a]||"remote"==a)c[a]=!0;for(g in c)this.setRule(g,c[g],!1)},getRules:function(){return this.rules},hasRule:function(a){return this.rules[a]?!0:!1},getValue:function(){var a=this.elem;if(!this.isField)return null;var b=p(a);if(this.checkbox)return a.checked?b||"1":"";if(this.radio){var a=this.radios,c,d;c=0;for(d=a.length;c<d;c++)if(a[c].checked)return p(a[c])}return this.phldr?b==this.phldr?"":b:b},getUserData:function(){return this.data},setUserData:function(a){var b=
this.data;this.data=a;return b},isEmpty:function(){return k(this.getValue(),this.elem)},enable:function(){this.enabled=!0;this.vldr.reset();return this},disable:function(){this.enabled=!1;!1===this.valid&&(this.setValidState(!0),this.doDisplayState());return this},enableDisplayState:function(){this.displayState=!0},disableDisplayState:function(){this.displayState=!1},isDisplayStateEnabled:function(){return this.displayState},toggleErrorBox:function(a){var b=this.cfg,c=b.errorBox.enabled;b.errorBox.enabled=
a;!c&&a&&a.displayState&&!1===this.valid()&&this.doDisplayState()},isEnabled:function(){return this.enabled},getElem:function(){return this.elem},getName:function(){return this.id},getError:function(){return this.error},getErrorRule:function(){return this.errorRule},isValid:function(){return this.isEnabled()?this.customError?!1:!0===this.valid&&!this.pending||0===this.rulesNum:!0},getExactValidState:function(){return this.valid},setCustomError:function(a,b){this.customError=a?!0:!1;this.setValidState(a?
!1:!0);this.setError(!0===a?null:a,b);this.doDisplayState()},reset:function(){this.abort();this.dirty=!1;this.prev="";this.setValidState(null);this.setError(null);this.doDisplayState();return this},abort:function(){this.pending&&(this.pending.abort(),this.pending=null);return this},check:function(a){var b=this.rules,c=this.cfg,d=this.elem;if(!this.isEnabled())return!0;if(this.customError)return!1;if(0==this.rulesNum&&!1!==this.valid)return!0;if(this.checking)return this.checkTmt||(this.checkTmt=setTimeout(l(this.checkTimeout,
this),100)),!0===this.valid;this.checking=!0;if(!(!0===a||b.equalTo||b.notEqualTo||this.dirty||null===this.valid||c.alwaysCheck))return this.pending||this.doDisplayState(),this.checking=!1,!0===this.valid;var g=!0,f=!1,e=this.getValue(),h,k;for(k in b)if("remote"==k){if(this.dirty||c.alwaysCheck||null===this.valid||!0===a)if(e||b[k].checkEmpty)f=!0}else if(!0!==(h=("function"==typeof b[k]?b[k]:s[k]).call(this.callbackScope,e,d,b[k],this))){g=!1;this.setError(B(h||c.messages[k]||"",b[k]),k);break}f=
f&&g;g&&this.setError(null);f?this.ajaxCheck():(this.setValidState(g),this.doDisplayState());this.checking=this.dirty=!1;this.trigger("check",this,this.valid);return!0===this.valid&&!f},doDisplayState:function(){var a=this.cfg,b=this.isValid(),c=a.cls.error,d=a.cls.valid,g=this.elem;this.displayState||a.alwaysDisplayState||(b=null);null===this.valid&&(b=null);c&&(!1===b?r(g,c):q(g,c));d&&(!0===b?r(g,d):q(g,d));c=this.getErrorBox();d=this.error;c&&(!1===b&&d&&(c.innerHTML=state.error),c.style.display=
!1===b&&d&&a.errorBox.enabled?"block":"none");this.trigger("displaystate",this,b,this.error)},getErrorBox:function(){var a=this.cfg.errorBox;return a.tag||a.fn||a.selector?(!this.errorBox&&a.enabled&&this.createErrorBox(),this.errorBox):null},destroy:function(){this.trigger("destroy",this);this.elem.removeAttribute("data-validator");this.errorBox&&this.errorBox.parentNode.removeChild(this.errorBox);this._observable.destroy();delete this._observable;delete this.vldr;delete this.cfg;delete this.errorBox;
delete this.rules;delete this.elem},isPending:function(){return null!==this.pending},setValidState:function(a){this.valid!==a&&(this.valid=a,this.trigger("statechange",this,a))},setError:function(a,b){if(this.error!=a||this.errorRule!=b)this.error=a,this.errorRule=b,this.trigger("errorchange",this,a,b)},checkTimeout:function(){this.checkTmt=null;this.checking||this.check(!1)},setEvents:function(a){var b=this.elem;a="bind"==a?n:C;var c=[],d=this.radio,g=this.radios,f,e,h,k=g?g.length:0;if(this.isField)for(this.checkbox||
this.radio||(c.push("focus"),c.push("blur"),c.push("keyup"),this.submittable&&this.cfg.allowSubmit&&c.push("keypress")),c.push("click"),c.push("change"),f=-1,e=c.length;++f<e;)if(d)for(h=-1;++h<k;a(g[h],c[f],this.onChangeDelegate));else a(b,c[f],this.onChangeDelegate)},onChange:function(a){a=a||window.event;if(this.processingEvent)return this.lastEvent=null,this.lastEvent=a,setTimeout(l(this.processEventTimeout,this),100),!0;this.processingEvent=!0;var b=this.getValue();"keypress"!=a.type&&this.prev!==
b&&(this.dirty=!0,this.abort());switch(a.type){case "focus":case "click":if(this.checkbox||this.radio||!this.pending)this.pending||this.check(!1);break;case "blur":this.dirty&&this.check(!1);break;case "keypress":if(this.submittable&&this.cfg.allowSubmit&&13==a.keyCode)return a.isDefaultPrevented&&!a.isDefaultPrevented()&&(this.trigger("submit",this,a),a.preventDefault&&a.preventDefault()),this.processingEvent=!1;break;case "keyup":case "change":this.customError=!1,this.check(!1)}this.prev=b;this.processingEvent=
!1;return!0},processEventTimeout:function(){if(this.processingEvent)this.lastEvent=null;else if(this.lastEvent){var a=this.lastEvent;this.lastEvent=null;this.onChange(a)}},createErrorBox:function(){var a=this.cfg.errorBox,b=a.tag,c=a.cls,d=a.fn,g=a.position,a=a.elem;d?this.errorBox=d.call(this.callbackScope,this):a?this.errorBox=a:(this.errorBox=document.createElement(b),this.errorBox.className=c,b=this.radio?this.radios[this.radios.length-1]:this.elem,"appendParent"==g?b.parentNode.appendChild(this.errorBox):
"before"==g?b.parentNode.insertBefore(this.errorBox,b):b.parentNode.insertBefore(this.errorBox,b.nextSibling))},ajaxCheck:function(){var a=this.elem,b=this.rules.remote,c=this.getValue(),d=this.cfg,b=f({},"string"==typeof b?{url:b}:b);b.data=b.data||{};b.data[b.paramName||a.getAttribute("name")||a.getAttribute("id")]=c;b.handler||(b.dataType="text");b.cache=!1;d.cls.ajax&&r(a,d.cls.ajax);this.trigger("beforeAjax",this,b);this.pending=(window.MetaphorJs?MetaphorJs.ajax:jQuery.ajax)(b);this.pending.done(l(this.onAjaxSuccess,
this));this.pending.fail(l(this.onAjaxError,this))},onAjaxSuccess:function(a){var b=this.rules,c=this.cfg;this.pending=null;var d=!0;b.remote.handler?(a=b.remote.handler.call(this.callbackScope,this,a),!0!==a&&(this.setError(B(a||c.messages.remote||"",b.remote),"remote"),d=!1)):a?(this.setError(a,"remote"),d=!1):this.setError(null);c.cls.ajax&&q(this.elem,c.cls.ajax);this.setValidState(d);this.doDisplayState();this.trigger("afterAjax",this)},onAjaxError:function(a,b){var c=this.cfg;c.cls.ajax&&q(this.elem,
c.cls.ajax);this.pending=null;"abort"!=b&&"abort"!=a&&(this.setValidState(!1),this.doDisplayState(),this.trigger("afterAjax",this))}});var L={alwaysCheck:!1,alwaysDisplayState:!1,disabled:!1,value:null,elem:null,errorBox:null,errorField:null,data:null,cls:{valid:"",error:""},fields:[],rules:{},messages:{},callback:{scope:null,destroy:null,statechange:null,errorchange:null,displaystate:null}},J=function(a,b){a=a||{};var c,d;this._observable=new A;this._vldr=b;f(this,this._observable.getApi());this.cfg=
c=f({},L,m.groupDefaults,a);this.callbackScope=d=c.callback.scope;this.data=a.data;this.el=a.elem;this.fields={};this.rules={};c.messages=f({},G,m.messages,c.messages);var g;if(c.callback)for(g in c.callback)if(c.callback[g])this.on(g,c.callback[g],d);c.rules&&this.setRules(c.rules,!1);if(c.fields)for(g=0,d=a.fields.length;g<d;g++)this.add(b.getField(c.fields[g]));this.enabled=!c.disabled};f(J.prototype,{fields:null,rules:null,cfg:null,callbackScope:null,vldr:null,enabled:!1,invalid:null,valid:null,
displayState:!1,rulesNum:0,error:null,data:null,errorBox:null,el:null,enable:function(){this.enabled=!0;return this},disable:function(){this.enabled=!1;return this},isEnabled:function(){return this.enabled},isValid:function(){return!this.enabled||0===this.invalid&&!0===this.valid},getExactValidState:function(){return this.valid},reset:function(){this.invalid=0;this.setValidState(null);this.setError(null);this.doDisplayState();return this},getUserData:function(){return this.data},getName:function(){return this.cfg.name},
setRules:function(a,b){b=void 0==b?!0:b;for(var c in a)this.setRule(c,a[c],!1);b?this.check():this.setValidState(null);return this},setRule:function(a,b,c){var d=this.rules;c=void 0==c?!0:c;null===b?(d[a]&&this.rulesNum--,delete d[a]):(d[a]||this.rulesNum++,d[a]=b,null!==this.valid&&this.setValidState(!1));c?this.check():this.setValidState(null);return this},getRules:function(){return f({},this.rules)},hasRule:function(a){return this.rules[a]?!0:!1},setError:function(a){var b=this.cfg;this.error!=
a&&(b.errorField?(this.vldr.getField(b.errorField).setError(a),this.error=null):(this.error=a,this.trigger("errorchange",this,a)))},getError:function(){return this.error},getFields:function(){return this.fields},enableDisplayState:function(){this.displayState=!0;return this},disableDisplayState:function(){this.displayState=!1;return this},check:function(){var a=this.cfg,b=this.fields,c=this.rules;if(!this.enabled||0==this.rulesNum)return this.setValidState(null),this.doDisplayState(),!0;this.countInvalid();
if(0<this.invalid)return this.setValidState(null),this.doDisplayState(),!0;var d={},g=!0,f=null,e;if(a.value){for(e in b)d[e]=b[e].getValue();f=a.value.call(this.callbackScope,d,this)}for(e in c)if(!0!==(b=("function"==typeof c[e]?c[e]:s[e]).call(this.callbackScope,f,null,c[e],this,d))){g=!1;b||a.messages[e]?this.setError(B(b||a.messages[e]||"",c[e])):this.setError(null);break}g&&this.setError(null);this.setValidState(g);this.doDisplayState();return!0===this.valid},doDisplayState:function(){var a=
this.valid,b=this.cfg;this.displayState||b.alwaysDisplayState||(a=null);if(b.errorBox){var c=this.getErrorBox();null!==a?c&&(c.innerHTML=this.error||"",c.style.display=!1===this.valid?"block":"none"):c&&(c.style.display="none")}c=b.cls.error;b=b.cls.valid;a=this.valid;c&&(!1===a?r(this.el,c):q(this.el,c));b&&(!0===a?r(this.el,b):q(this.el,b));this.trigger("displaystate",this,this.valid)},getErrorBox:function(){var a=this.cfg,b=this.fields,c=a.errorBox;if(b[c])return b[c].getErrorBox();this.errorBox||
(this.errorBox="function"==typeof a.errorBox?a.errorBox.call(this.callbackScope,this):a.errorBox);return this.errorBox},destroy:function(){var a=this.fields,b;for(b in a)a[b]&&(this.setFieldEvents(a[b],"un"),delete a[b]);this.errorBox&&this.errorBox.parentNode.removeChild(this.errorBox);this._observable.destroy();delete this._observable;delete this.vldr;delete this.rules;delete this.fields;delete this.cfg},add:function(a){var b=this.fields,c=a.getName();b[c]||(b[c]=a,this.setFieldEvents(a,"on"))},
setFieldEvents:function(a,b){a[b]("statechange",this.onFieldStateChange,this)},remove:function(a){var b=this.fields,c=a.getName();b[c]&&(delete b[c],this.setFieldEvents(a,"un"));return this},setValidState:function(a){this.valid!==a&&(this.valid=a,this.trigger("statechange",this,a))},countInvalid:function(){var a=this.fields;this.invalid=0;for(var b in a)this.invalid+=a[b].isValid()?0:1},onFieldStateChange:function(a,b){this.trigger("fieldstatechange",this,a,b);this.check()}});var M={form:null,all:{},
fields:{},rules:{},cls:{valid:"",error:"",checking:""},groups:{},callback:{scope:null,destroy:null,reset:null,beforesubmit:null,submit:null,statechange:null,check:null,displaystate:null,displaystatechange:null}},m=function(a,b,c){var d=a.nodeName.toLowerCase();this.vldId=++x;u[this.vldId]=this;a.setAttribute("data-validator",this.vldId);this.el=a;b&&"string"!=typeof b&&(c=b,b=null);this._observable=new A;this.cfg=a=f({},M,m.defaults,m[b],c);this.callbackScope=b=a.callback.scope;this.isForm="form"==
d;this.isField=/input|select|textarea/.test(d);this.fields={};this.groups={};f(this,this._observable.getApi());this.onRealSubmitClickDelegate=l(this.onRealSubmitClick,this);this.resetDelegate=l(this.reset,this);this.onSubmitClickDelegate=l(this.onSubmitClick,this);this.onFormSubmitDelegate=l(this.onFormSubmit,this);delete a.callback.scope;var g,e;for(e in a.callback)this.on(e,a.callback[e],b);this.initFields();d=this.fields;for(g in a.rules)d[g]&&d[g].setRules(a.rules[g],!1);a.rules=null;for(g in a.groups)this.addGroup(g,
a.groups[g]);this.initForm("bind");delete a.rules;delete a.fields;delete a.groups;this.enabled=!0};f(m.prototype,{vldId:null,el:null,cfg:null,enabled:!1,invalid:null,pending:0,grps:0,outside:!0,submitted:!1,displayState:!1,isForm:!1,isField:!1,submitButton:null,hidden:null,callbackScope:null,_observable:null,fields:null,groups:null,getVldId:function(){return this.vldId},getElem:function(){return this.el},getGroup:function(a){return this.groups[a]||null},getField:function(a){return this.fields[a]||
null},enable:function(){this.enabled=!0;return this},disable:function(){this.enabled=!1;return this},isEnabled:function(){return this.enabled},enableDisplayState:function(){var a=this.fields,b=this.groups,c;if(!0!==this.displayState){this.displayState=!0;for(c in a)a[c].enableDisplayState();for(c in b)b[c].enableDisplayState();this.trigger("displaystatechange",this,!0)}return this},disableDisplayState:function(){var a=this.groups,b=this.fields,c;if(!1!==this.displayState){this.displayState=!1;for(c in b)b[c].disableDisplayState();
for(c in a)a[c].disableDisplayState();this.trigger("displaystatechange",this,!1)}return this},isDisplayStateEnabled:function(){return this.displayState},isValid:function(){return!1===this.enabled?!0:0===this.invalid&&0===this.pending&&0===this.grps&&!0===this.outside},getErrors:function(a){var b=!0==a?[]:{},c,d,g,f=[this.fields,this.groups],e;if(!this.isEnabled())return b;for(g=0;2>g;g++)for(d in e=f[g],e)null===e[d].getExactValidState()&&e[d].check(),e[d].isValid()||(c=e[d].getError())&&(a?b.push(c):
b[d]=c);return b},check:function(){var a=this.fields,b=this.groups;if(!this.isEnabled())return!0;var c=this.isValid(),d;for(d in a)a[d].check();for(d in b)b[d].check();this.outside=!1!==this.trigger("check",this);a=this.isValid();c!=a&&(this.doDisplayState(),this.trigger("statechange",this,!1));return a},add:function(a,b){if(!F(a)||null!==a.getAttribute("data-no-validate")||null!==a.getAttribute("data-validator"))return this;var c=a.getAttribute("name")||a.getAttribute("id"),d=this.cfg,g=this.fields;
if(!c)return this;c=d.fields&&d.fields[c]?d.fields[c]:b||{};"string"==typeof c&&(c={rules:[c]});c=f({},d.all||{},c);if(c.ignore)return this;c.callback||(c.callback={scope:this.callbackScope});d=new I(a,c,this);c=d.getName();if(g[c])return this;g[c]=d;this.setFieldEvents(d,"on");this.displayState&&d.enableDisplayState();this.isEnabled()&&null!==this.invalid&&d.check();return this},addGroup:function(a,b){var c=this.groups;c[a]||(b.name=a,c[a]=new J(b,this),this.setGroupEvents(c[a],"on"),this.isEnabled()&&
null!==this.invalid&&c[a].check())},focusInvalid:function(){var a=this.fields,b;for(b in a)if(!a[b].isValid()){a[b].getElem().focus();break}},reset:function(){var a=this.fields,b=this.groups,c;this.submitted=!1;this.disableDisplayState();for(c in b)b[c].reset();for(c in a)a[c].reset();this.pending=0;this.invalid=null;this.grps=0;this.outside=!1;this.doDisplayState();this.trigger("reset",this);return this},submit:function(){var a=this.el;if(this.isForm)if("function"==typeof a.submit)!1!==this.trigger("beforesubmit",
this)&&!1!==this.trigger("submit",this)&&a.submit();else this.onSubmit();else this.onSubmit()},setFieldEvents:function(a,b){a[b]("statechange",this.onFieldStateChange,this);a[b]("beforeAjax",this.onBeforeAjax,this);a[b]("afterAjax",this.onAfterAjax,this);a[b]("submit",this.onFieldSubmit,this);a[b]("destroy",this.onFieldDestroy,this)},setGroupEvents:function(a,b){a[b]("statechange",this.onGroupStateChange,this)},initFields:function(){var a=this.el,b,c;if(this.isField)return this.add(a),this;this.isForm?
b=a.elements:a.querySelectorAll?b=a.querySelectorAll("input, textarea, select"):(b=[],v(a,function(a){var c=a.nodeName.toLowerCase();"input"!=c&&"textarea"!=c&&"select"!=c||b.push(a)}));a=-1;for(c=b.length;++a<c;this.add(b[a]));return this},initForm:function(a){var b=this.el,c=b.getElementsByTagName("input"),d=b.getElementsByClassName("submit"),f=b.getElementsByClassName("reset");a="bind"==a?n:C;var e,h,k,l;e=0;for(h=c.length;e<h;e++)l=c[e],k=l.type,"submit"==k?a(l,"click",this.onRealSubmitClickDelegate):
"reset"==k&&a(l,"click",this.resetDelegate);e=-1;for(h=d.length;++e<h;!z(d[e],"submit")&&a(d[e],"click",this.onSubmitClickDelegate));e=-1;for(h=f.length;++e<h;!z(f[e],"reset")&&a(f[e],"click",this.resetDelegate));this.isForm&&a(b,"submit",this.onFormSubmitDelegate)},onRealSubmitClick:function(a){a=a||window.event;this.submitButton=a.target||a.srcElement;return this.onSubmit(a)},onSubmitClick:function(a){return this.onSubmit(a||window.event)},onFormSubmit:function(a){return this.onSubmit(a||window.event)},
onFieldSubmit:function(a,b){this.enableDisplayState();this.submitted=!0;return this.onSubmit(b)},onSubmit:function(a){this.enableDisplayState();if(this.pending)return a&&a.preventDefault&&a.preventDefault(),!1;var b=this.submitButton?!0:!1;this.isForm&&(this.hidden&&(this.el.removeChild(this.hidden),this.hidden=null),this.submitButton&&/input|button/.test(this.submitButton.nodeName)&&(this.hidden=document.createElement("input"),this.hidden.type="hidden",this.hidden.setAttribute("name",this.submitButton.name),
this.hidden.value=this.submitButton.value,this.el.appendChild(this.hidden)));this.submitButton=null;if(!this.isValid()&&(this.check(),this.onFieldStateChange(),this.pending))return a&&a.preventDefault&&a.preventDefault(),!1;if(!1===this.trigger("beforesubmit",this)||!this.isValid())return a&&(a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation()),this.pending||(this.focusInvalid(),this.submitted=!1),this.trigger("failedsubmit",this,b),!1;this.pending||(this.submitted=!1);return!1!==
this.trigger("submit",this)},onFieldDestroy:function(a){a=a.getElem();a=a.getAttribute("name")||a.getAttribute("id");delete this.fields[a]},onFieldStateChange:function(a,b){var c=this.invalid,d=this.fields;this.invalid=0;for(var e in d)this.invalid+=d[e].isValid()?0:1;a&&this.trigger("fieldstatechange",this,a,b);if(null===c||null!==c&&this.invalid!==c)this.doDisplayState(),this.trigger("statechange",this,this.isValid())},onGroupStateChange:function(){var a=this.groups,b=this.grps;this.grps=0;for(var c in a)this.grps+=
a[c].isValid()?0:1;if(null===b||null!==b&&this.grps!==b)this.doDisplayState(),this.trigger("statechange",this,this.isValid())},doDisplayState:function(){var a=this.cfg,b=this.isValid(),c=a.cls.error,a=a.cls.valid,d=this.el;if(this.isField||!this.displayState)b=null;null===this.invalid&&(b=null);c&&(!1===b?r(d,c):q(d,c));a&&(!0===b?r(d,a):q(d,a));this.trigger("displaystate",this,b)},onBeforeAjax:function(){this.pending++;this.cfg.cls.ajax&&r(this.el,this.cfg.cls.ajax)},onAfterAjax:function(){var a=
this.fields,b=this.cfg;this.pending=0;for(var c in a)this.pending+=a[c].isPending()?1:0;this.doDisplayState();b.cls.ajax&&q(this.el,b.cls.ajax);this.submitted&&0==this.pending&&(this.submitted=!1,this.isValid()?this.submit():this.focusInvalid())},destroy:function(){var a=this.groups,b=this.fields,c;this.reset();this.trigger("destroy",this);delete u[this.vldId];for(c in a)a.hasOwnProperty(c)&&a[c]&&(this.setGroupEvents(a[c],"un"),a[c].destroy(),delete a[c]);for(c in b)b.hasOwnProperty(c)&&b[c]&&(this.setFieldEvents(b[c],
"un"),b[c].destroy(),delete b[c]);this._observable.destroy();delete this._observable;this.initForm("unbind");delete this.fields;delete this.groups;delete this.el;delete this.cfg}});m.defaults={};m.messages={};m.fieldDefaults={};m.groupDefaults={};m.addMethod=function(a,b,c){s[a]||(s[a]=b,c&&(m.messages[a]=c))};m.getValidator=function(a){a=a.getAttribute("data-validator");return u[a]||null};window.MetaphorJs&&MetaphorJs.ns?MetaphorJs.ns.register("MetaphorJs.lib.Validator",m):(window.MetaphorJs=window.MetaphorJs||
{},MetaphorJs.lib=MetaphorJs.lib||{},MetaphorJs.lib.Validator=m)})();
(function(){var x=MetaphorJs.lib.Validator,u=MetaphorJs.bind,y=MetaphorJs.lib.Watchable.createFunc,p=function(e,f,h){var l,n=e.childNodes;if(!1!==f.call(h,e))for(e=-1,l=n.length>>>0;++e!==l;p(n[e],f,h));};MetaphorJs.define("MetaphorJs.view.Validator",{node:null,scope:null,validator:null,scopeState:null,initialize:function(e,f){this.node=e;this.scope=f;this.scopeState={};this.validator=this.createValidator();this.initScope();this.initScopeState();this.initValidatorEvents()},createValidator:function(){var e=
this.node,f={},h;if(h=e.getAttribute("mjs-validator-submit"))f.callback={},f.callback.submit=function(e,f){return function(){try{e(f)}catch(h){console.log(h)}}}(y(h),this.scope);return new x(e,f)},initValidatorEvents:function(){var e=this.validator;e.on("fieldstatechange",this.onFieldStateChange,this);e.on("statechange",this.onFormStateChange,this);e.on("displaystatechange",this.onDisplayStateChange,this);e.on("reset",this.onFormReset,this)},initScope:function(){var e=this.scope,f=this.node,f=f.getAttribute("name")||
f.getAttribute("id")||"$form";e[f]=this.scopeState},initScopeState:function(){var e=this.node,f=this.scopeState,h,l,n;e.elements?h=e.elements:(h=[],p(e,function(e){var f=e.nodeName.toLowerCase(),l=e.type;"input"!=f&&"textarea"!=f&&"select"!=f||"submit"==l||"reset"==l||h.push(e)}));e=-1;for(n=h.length;++e<n;)l=h[e],(l=l.getAttribute("name")||l.getAttribute("id"))&&!f[l]&&(f[l]={$error:null,$invalid:null,$pristine:!0,$errorMessage:null});f.$invalid=!1;f.$pristine=!0;f.$submit=u(this.validator.onFormSubmit,
this.validator)},onDisplayStateChange:function(e,f){if(f){f=this.scopeState;var h,l;for(h in f)l=f[h],l.$real&&(f[h]=l.$real);f.$invalid=!e.isValid();f.$pristine=!1;this.scope.$check()}else this.onFormReset(e)},onFormReset:function(e){e=this.scopeState;var f,h;for(f in e)h=e[f],h.$error=null,h.$errorMessage=null,h.$invalid=null,h.$pristine=!0;e.$invalid=!1;e.$pristine=!0;this.scope.$check()},onFormStateChange:function(e,f){var h=this.scopeState;h.$invalid=!1===f&&e.isDisplayStateEnabled();h.$pristine=
!1;this.scope.$check()},onFieldStateChange:function(e,f,h){var l=this.scopeState,n=f.getName();e=e.isDisplayStateEnabled();f={$error:f.getErrorRule(),$errorMessage:f.getError(),$invalid:!1===h,$pristine:null===f.getExactValidState()};e?l[n]=f:l[n].$real=f;this.scope.$check()}});var t=MetaphorJs.ns.get;MetaphorJs.registerAttributeHandler("mjs-validate",250,function(e,f,h){h=h||"MetaphorJs.view.Validator";var l=t(h);l?new l(f,e):MetaphorJs.asyncError(Error("Class '"+h+"' not found"))})})();
