(function(){'use strict';(function(){var b={}.undefined,e=function(a,c,g){if(c&&a)for(var f in c)if(c.hasOwnProperty(f))if(a[f]&&"object"==typeof a[f]&&"object"==typeof c[f])e(a[f],c[f]);else if(!1!==g||a[f]===b||null===a[f])a[f]=c[f]},a={apply:e,emptyFn:function(){},cookie:{set:function(a,c,g){g&&"number"==typeof g&&(g=new Date((new Date).getTime()+1E3*g));c=encodeURIComponent(c)+(g?"; expires="+g.toUTCString():"")+"; path=/";document.cookie=encodeURIComponent(a)+"="+c},get:function(a){for(var c,g,f=document.cookie.split(";"),
b=0,e=f.length;b<e;b++)if(c=f[b].substr(0,f[b].indexOf("=")),g=f[b].substr(f[b].indexOf("=")+1),c=c.replace(/^\s+|\s+$/g,""),c==a)return decodeURIComponent(g);return null}},fn:{delegate:function(a,c){return function(){return a.apply(c,arguments)}},defer:function(a,c,g){c=this.delegate(c,g);return setTimeout(c,a)},countdown:function(a,c,g){a=parseInt(a,10);return function(){a--;0==a&&c.apply(g,arguments)}}}};window.MetaphorJs?e(window.MetaphorJs,a,!0):window.MetaphorJs=a})();(function(){var b=window,e={},a=function(a,c){var g;g=a.split(".");var f,h=g.pop();f=g.join(".");var k=g.length,l,m=b;if(e[f])g=[e[f],h];else{for(f=0;f<k;f++)l=g[f],m[l]||(m[l]={}),m=m[l];g=[m,h]}g[0][g[1]]=c;e[a]=c};a("MetaphorJs.ns",{register:a,exists:function(a){return e[a]?!0:!1},get:function(a){if(e[a])return e[a];a=a.split(".");var c,g=a.length,f,h=b;for(c=0;c<g;c++){f=a[c];if(!h[f])return null;h=h[f]}return h},add:function(a,c){e[a]=c},remove:function(a){delete e[a]}})})();(function(){var b={}.undefined,e=function(a){return c(function(){},a)},a=function(a,c,d){return function(){var e=b;this.supr=a.prototype[c]||function(){};e=d.apply(this,arguments);this.supr=null;return e}},d=function(c,d,b){for(var e in d)d.hasOwnProperty(e)&&(c[e]="function"===typeof d[e]&&b.prototype&&"function"===typeof b.prototype[e]?a(b,e,d[e]):d[e])},c=function(a,c){var b=function(){};b.prototype=a.prototype;var b=new b,e=function(){this.initialize&&this.initialize.apply(this,arguments)};d(b,
c,a);e.prototype=b;e.prototype.constructor=e;e.prototype.getClass=function(){return this.__proto__.constructor.__class};e.prototype.getParentClass=function(){return this.__proto__.constructor.__parentClass};e.__instantiate=function(a){return function(){var c=function(){},d;c.prototype=a.prototype;c=new c;d=a.prototype.constructor.apply(c,arguments);return"object"==typeof d?d:c}}(e);return e};MetaphorJs.define=MetaphorJs.d=function(a,d,b,k){"string"!=typeof d&&(k=b,b=d,d=null);var l=d&&"string"==typeof d?
MetaphorJs.ns.get(d):d;if(d&&!l)throw Error(d+" not found");d=l?c(l,b):e(b);d.__parent=l;d.__parentClass=l?l.__class:null;d.__class=a;if(k)for(var m in k)k.hasOwnProperty(m)&&(d[m]=k[m]);MetaphorJs.ns.register(a,d);b.alias&&MetaphorJs.ns.add(b.alias,d);return d};MetaphorJs.create=MetaphorJs.c=function(a){var d=MetaphorJs.ns.get(a),c=Array.prototype.slice.call(arguments,1);if(!d)throw Error(a+" not found");return d.__instantiate.apply(this,c)};MetaphorJs.is=function(a,d){var c="string"==typeof d?MetaphorJs.ns.get(d):
d;return c?a instanceof c:!1};MetaphorJs.isSubclass=MetaphorJs.iss=function(a,d){var c=a;for("string"!=typeof d&&(d=d.getClass());c;){if(c==d)return!0;(c=MetaphorJs.ns.get(c))&&(c=c.getParentClass())}return!1}})();MetaphorJs.define("MetaphorJs.cmp.Base",{initialize:function(b){b=b||{};MetaphorJs.apply(this,b)},destroy:MetaphorJs.emptyFn});(function(){var b=function(a){var c,b,f,e;b=1;for(f=arguments.length;b<f;b++)for(c in e=arguments[b],e)a[c]=e[c]},e=function(a,c){var g=[],f={},e=Array(11).join((Math.random().toString(36)+"00000000000000000").slice(2,18)).slice(0,10),k=!1,l=0,m=this;c=c||!1;b(m,{destroy:function(){a=m=l=k=e=f=g=null},on:function(c,b,n){if(c){b=b||c;n=n||{};var k=a+"_"+e;if(!b[k]){var m=++l,p=n.first||!1;b[k]=m;c={fn:c,scope:b,id:m,called:0,limit:n.limit?n.limit:n.once?1:0,start:n.start||1,count:0};p?g.unshift(c):
g.push(c);f[m]=c;return m}}},un:function(c,b){var n=-1,k=a+"_"+e,l;l=c==parseInt(c)?c:(b||c)[k];if(!l)return!1;for(var m=0,q=g.length;m<q;m++)if(g[m].id==l){n=m;delete g[m].scope[k];break}if(-1==n)return!1;g.splice(n,1);delete f[l];return!0},hasListener:function(c,b){if(c){b=b||c;var f;f=a+"_"+e;f=c==parseInt(c)?c:b[f];if(!f)return!1;for(var k=0,l=g.length;k<l;k++)if(g[k].id==f)return!0;return!1}return 0<g.length?g.length:!1},removeAllListeners:function(){for(var c=a+"_"+e,b=0,k=g.length;b<k;b++)delete g[b].scope[c];
g=[];f={}},suspend:function(){k=!0},resume:function(){k=!1},trigger:function(){if(!k&&0!=g.length){var a="all"==c?[]:null,d=[],b,e;b=0;for(e=g.length;b<e;b++)d.push(g[b]);for(;b=d.shift();)if(b&&f[b.id]&&(b.count++,!(b.count<b.start))){e=b.fn.apply(b.scope,arguments);b.called++;b.called==b.limit&&this.un(b.id);"all"==c&&a.push(e);if("first"==c&&e)return e;"last"==c&&e&&(a=e);if(!1==c&&!1===e)break}if(c)return a}}})},a=function(){var a=this,c={},g={};b(g,{createEvent:function(a,d){a=a.toLowerCase();
c[a]||(c[a]=new e(a,d));return c[a]},getEvent:function(a){a=a.toLowerCase();return c[a]},on:function(a,d,b,g){a=a.toLowerCase();c[a]||(c[a]=new e(a));return c[a].on(d,b,g)},once:function(c,b,g,e){e=e||{};e.limit=1;return a.on(c,b,g,e)},un:function(a,d,b){a=a.toLowerCase();c[a]&&c[a].un(d,b)},hasListener:function(a,d,b){a=a.toLowerCase();return c[a]?c[a].hasListener(d,b):!1},removeAllListeners:function(a){c[a]&&c[a].removeAllListeners()},trigger:function(){var a=[],d=arguments[0],d=d.toLowerCase();
if(c[d]){for(var b=1,g=arguments.length;b<g;b++)a.push(arguments[b]);d=c[d];return d.trigger.apply(d,a)}},suspendEvent:function(a){a=a.toLowerCase();c[a]&&c[a].suspend()},suspendAllEvents:function(){for(var a in c)c[a].suspend()},resumeEvent:function(a){a=a.toLowerCase();c[a]&&c[a].resume()},resumeAllEvents:function(){for(var a in c)c[a].resume()}});b(a,g,{destroy:function(b){if(b)b=b.toLowerCase(),c[b]&&(c[b].destroy(),delete c[b]);else{for(var g in c)c[g].destroy();a=c=null}},getApi:function(){return g}});
return a};window.MetaphorJs&&MetaphorJs.ns?MetaphorJs.ns.register("MetaphorJs.lib.Observable",a):(window.MetaphorJs=window.MetaphorJs||{},MetaphorJs.lib=MetaphorJs.lib||{},MetaphorJs.lib.Observable=a)})();MetaphorJs.define("MetaphorJs.cmp.Observable","MetaphorJs.cmp.Base",{_observable:null,listeners:null,initialize:function(b){this._observable=new MetaphorJs.lib.Observable;MetaphorJs.apply(this,this._observable.getApi());b=b||{};if(b.callback){var e=b.callback,a=e.scope||this;delete e.scope;for(var d in e)if(e.hasOwnProperty(d))this.on(d,e[d],a);delete b.callback}this.supr(b)},destroy:function(){this._observable.destroy();delete this._observable;this.supr()}});(function(){var b={},e=-1,a=function(a){return b[a]||null};MetaphorJs.define("MetaphorJs.cmp.Component","MetaphorJs.cmp.Observable",{id:null,tag:"div",el:null,dom:null,cls:null,style:null,renderTo:null,html:null,rendered:!1,hidden:!1,destroyed:!1,destroyEl:!0,initialize:function(a){this.supr(a);this.dom&&!this.el&&(this.el=$(this.dom));this.el&&(this.id=this.el.attr("id"),this.dom||(this.dom=this.el.get(0)));e++;this.id=this.id||"cmp-"+e;b[this.id]=this;this.initComponent();!this.dom&&this.renderTo?
this.render():this.dom&&(this.hidden=this.el.is(":hidden"),this.rendered=!0,this.html&&(this.el.html(this.html),this.html=null),this.onRender())},render:function(a){if(!this.rendered){var c=this.tag,c=$("<"+c+"></"+c+">");a=a||this.renderTo;this.cls&&c.addClass(this.cls);this.style&&c.css(this.style);c.attr("id",this.id);this.html&&(c.html(this.html),this.html=null);this.hidden&&c.hide();c.appendTo(a||"body");this.el=c;this.dom=c.get(0);this.rendered=!0;this.onRender();this.renderTo=null}},setContent:function(a){this.rendered?
this.el.html(a):this.html=a},onRender:function(){this.el.attr("cmp-id",this.id);this.trigger("render",this);this.afterRender();this.trigger("afterrender",this)},show:function(){if(this.hidden){if(!1===this.trigger("beforeshow",this))return!1;this.el.show();this.hidden=!1;this.onShow();this.trigger("show",this)}},hide:function(){if(!this.hidden){if(!1===this.trigger("beforehide",this))return!1;this.el.hide();this.hidden=!0;this.onHide();this.trigger("hide",this)}},isHidden:function(){return this.hidden},
isRendered:function(){return this.rendered},isDestroyed:function(){return this.destroyed},getEl:function(){return this.el},getDom:function(){return this.dom},destroy:function(){if(!this.destroyed){if(!1===this.trigger("beforedestroy",this))return!1;this.onDestroy();this.destroyed=!0;this.trigger("destroy",this);this.destroyEl&&(this.el.remove(),this.dom=this.el=null);this.supr();delete b[this.id]}},initComponent:MetaphorJs.emptyFn,afterRender:MetaphorJs.emptyFn,onShow:MetaphorJs.emptyFn,onHide:MetaphorJs.emptyFn,
onDestroy:MetaphorJs.emptyFn});MetaphorJs.getCmp=a;$.fn.createCmp=function(d,c){var b=null;d&&"string"!=typeof d&&(c=d,d=null);d=d||"MetaphorJs.cmp.Component";c=c||{};this.each(function(){var e=$(this),h=e.attr("cmp-id");if(h)return b=a(h),!1;c.el=e;c.dom=this;b=MetaphorJs.create(d,c);return!1});return b};$.fn.getCmp=function(){return a(this.attr("cmp-id"))};$.fn.getParentCmp=function(){if(this.attr("cmp-id"))return MetaphorJs.getCmp(el.attr("cmp-id"));var a=this.parents("[cmp-id]").eq(0);return a.length?
MetaphorJs.getCmp(a.attr("cmp-id")):null}})();(function(){var b={},e={};MetaphorJs.define("MetaphorJs.data.Model",{type:null,fields:null,record:null,store:null,plain:!1,initialize:function(a){this.fields={};MetaphorJs.apply(this,a);this.record=this.record||{};this.store=this.store||{};this.plain=this.type?!1:!0;MetaphorJs.apply(this.record,{load:null,save:null,delete:null,id:null,data:null,success:null,extra:{}},!1);MetaphorJs.apply(this.store,{load:null,save:null,delete:null,id:null,data:null,total:null,start:null,limit:null,success:null,extra:{}},
!1)},isPlain:function(){return this.plain},getRecordProp:function(a,d){return this.getProp("record",a,d)},getStoreProp:function(a,d){return this.getProp("store",a,d)},getProp:function(a,d,c){a=this[a];return a[d]&&a[d][c]||a[c]||this[c]||null},_createAjaxCfg:function(a,d,c,b){var e=this[a],h="string"==typeof e[d]?{url:e[d]}:e[d],k=this.getProp(a,d,"id"),l=this.getProp(a,d,"data");if(!h)throw Error(a+"."+d+" not defined");h.data=$.extend(!0,{},h.data,this.extra,e.extra,e[d].extra);h.type||(h.type=
"load"==d?"GET":"POST");c&&(h.data[k]=c);b&&(l?h.data[l]=b:h.data=b);return h},_processRecordResponse:function(a,d,c){var b=this.getRecordProp(a,"id"),e=this.getRecordProp(a,"data"),b=(e=e?d[e]:d)&&e[b]||d[b];this._getSuccess("record",a,d)?c.resolve(b,e):c.reject(d)},_processStoreResponse:function(a,d,c){var b=this.getStoreProp(a,"data"),e=this.getStoreProp(a,"total"),b=b?d[b]:d,e=e?d[e]:null;this._getSuccess("store",a,d)?c.resolve(b,e):c.reject(d)},_getSuccess:function(a,d,c){return(a=this.getProp(a,
d,"success"))?c[a]:!0},loadRecord:function(a){var d=this;a=$.ajax(d._createAjaxCfg("record","load",a));var c=new jQuery.Deferred;a.then(function(a){d._processRecordResponse("load",a,c)},c.reject);return c.promise()},saveRecord:function(a){var d=this;a=$.ajax(d._createAjaxCfg("record","save",a.getId(),a.storeData(a.getData())));var c=new jQuery.Deferred;a.then(function(a){d._processRecordResponse("save",a,c)},c.reject);return c.promise()},deleteRecord:function(a){var d=this;a=$.ajax(this._createAjaxCfg("record",
"delete",a.getId()));var c=new jQuery.Deferred;a.then(function(a){c[d._getSuccess("record","delete",a)?"resolve":"reject"]()},c.reject);return c.promise()},loadStore:function(a,d,c){var b=this;a=b._createAjaxCfg("store","load");var e=new jQuery.Deferred;a.data=$.extend(!0,a.data,d);$.ajax(a).then(function(a){b._processStoreResponse("load",a,e)},e.reject);return e.promise()},saveStore:function(a,d){var c=this,b=$.ajax(c._createAjaxCfg("store","save",null,d)),e=new jQuery.Deferred;b.then(function(a){c._processStoreResponse("save",
a,e)},e.reject);return e.promise()},deleteRecords:function(a,d){var c=this,b=$.ajax(c._createAjaxCfg("store","delete",d)),e=new jQuery.Deferred;b.then(function(a){e[c._getSuccess("store","delete",a)?"resolve":"reject"]()},e.reject);return e.promise()},getFields:function(){return this.fields},restoreField:function(a,d,c){var b=this.fields[d];if(b){switch("string"==typeof b?b:b.type){case "int":c=parseInt(c);break;case "bool":case "boolean":"string"==typeof c?(c=c.toLowerCase(),c="off"===c||"no"===
c||"0"===c||"false"==c||"null"==c?!1:!0):c=c?!0:!1;break;case "double":case "float":c=parseFloat(c);break;case "date":b.parseFn?c=b.parseFn(c,b.format):Date.parse?c=Date.parse(c,b.format):("timestamp"==b.format&&(c=1E3*parseInt(c)),c=new Date(c))}b.restore&&(c=b.restore.call(a,c,d))}return this.onRestoreField(a,d,c)},onRestoreField:function(a,d,c){return c},storeField:function(a,d,c){var b=this.fields[d];if(b){switch("string"==typeof b?b:b.type){case "bool":case "boolean":c=c?"1":"0";break;case "date":c=
b.formatFn?b.formatFn(c,b.format):Date.format?Date.format(c,b.format):"timestamp"==b.format?c.getTime()/1E3:c.format?c.format(b.format):c.toString();break;default:c=c.toString()}b.store&&(c=b.store.call(a,c,d))}return this.onStoreField(a,d,c)},onStoreField:function(a,d,c){return c}},{create:function(a,d){return"MetaphorJs.data.Model"==a?MetaphorJs.create(a,d):d?MetaphorJs.create(a,d):b[a]?b[a]:b[a]=MetaphorJs.create(a)},addToCache:function(a){var d=a.getClass(),c=a.getId();"MetaphorJs.data.Record"!=
d&&(e[d]||(e[d]={}),e[d][c]=a)},getFromCache:function(a,d){return e[a]&&e[a][d]?e[a][d]:null},removeFromCache:function(a,d){e[a]&&e[a][d]&&delete e[a][d]}})})();(function(){var b=0,e={};MetaphorJs.define("MetaphorJs.data.Store","MetaphorJs.cmp.Observable",{id:null,autoLoad:!1,clearOnLoad:!0,model:null,loaded:!1,loading:!1,local:!1,items:null,map:null,keys:null,length:0,totalLength:0,start:0,pages:null,filtered:!1,filterBackup:null,filterFn:null,filterScope:null,filterParams:null,initialize:function(a,d,c){this.items=[];this.map={};this.keys=[];this.loaded=!1;a&&"string"!=typeof a&&(c=d,d=a,a=null);d=d||{};this.supr(d);this.id=this.id||++b;e[this.id]=this;
"string"==typeof this.model?this.model=MetaphorJs.create(this.model):MetaphorJs.is(this.model,"MetaphorJs.data.Model")||(this.model=MetaphorJs.create("MetaphorJs.data.Model",this.model));if(a||d.url)this.model.store.load=a||d.url;!this.local&&this.autoLoad?this.load():c&&(_.isArray(c)?this.loadArray(c):this.loadAjaxData(c));this.local&&(this.loaded=!0)},getId:function(){return this.id},isLoaded:function(){return this.loaded},isLocal:function(){return this.local},setLocal:function(a){this.local=a?
!0:!1},isLoading:function(){return this.loading},isFiltered:function(){return this.filtered},getLength:function(){return this.length},getTotalLength:function(){return this.filtered?this.length:this.totalLength||this.length},getPagesCount:function(){return null!==this.pageSize?parseInt(this.totalLength/this.pageSize):1},setParam:function(a,d){this.model.store.extra[a]=d},getParam:function(a){return this.model.store.extra[a]},getAjaxData:function(){return this.ajaxData},hasDirty:function(){if(this.model.isPlain())return!1;
var a=!1;this.each(function(d){if(d.isDirty())return a=!0,!1});return a},getDirty:function(){var a=[];if(this.model.isPlain())return a;this.each(function(d){d.isDirty()&&a.push(d)});return a},import:function(a){this.suspendAllEvents();for(var d=0;d<a.length;d++)this.add(a[d]);this.resumeAllEvents();this.loaded=!0;this.loading=!1;this.trigger("load",this)},load:function(a){var d=this,c=d.model.store,b=c.start,c=c.limit;a=a||{};null===d.pageSize||a[b]||a[c]||(a[b]=d.start,a[c]=d.pageSize);if(!1!==d.trigger("beforeload",
d))return d.model.loadStore(d,a).then(function(a,c){d.import(a);d.totalLength=parseInt(c)},function(){d.trigger("failedload",d)})},save:function(){var a=this,d={},c=0;if(a.model.isPlain())throw Error("Cannot save plain store");a.each(function(a){a.isDirty()&&(d[a.getId()]=a.storeData(a.getData()),c++)});if(!c)throw Error("Nothing to save");if(!1!==a.trigger("beforesave",a,d))return a.model.saveStore(a,d).then(function(c){var d,b,e;if(c&&c.length)for(d=0,b=c.length;d<b;d++)e=a.getRecordId(c[d]),(e=
a.getById(e))&&e.import(c[d]);a.trigger("save",a)},function(){a.trigger("failedsave",a)})},deleteById:function(a){var d=this,c,b,e;if(!a||_.isArray(a)&&!a.length)throw Error("Record id required");_.isArray(a)||(a=[a]);c=0;for(b=a.length;c<b;c++)e=d.getById(a[c]),e instanceof MetaphorJs.data.Record?e.destroy():d.removeId(a[c]);if(!1!==d.trigger("beforedelete",d,a))return d.model.deleteRecords(d,a).then(function(){d.trigger("delete",d,a)},function(){d.trigger("faileddelete",d,a)})},deleteAt:function(a){var d=
this.getAt(a);if(!d)throw Error("Record not found at "+a);return this.deleteRecord(d)},delete:function(a){return this.deleteById(this.getRecordId(a))},deleteRecords:function(a){var d=[],c,b;c=0;for(b=a.length;c<b;c++)d.push(this.getRecordId(a[c]));return this.deleteById(d)},loadAjaxData:function(a){var d=this;!1!==d.trigger("beforeload",d)&&d.model._processStoreResponse("load",a,{resolve:function(a,b){d.import(a);d.totalLength=parseInt(b)},reject:function(){}})},loadArray:function(a,d){!1!==this.trigger("beforeload",
this)&&(!d&&this.clearOnLoad&&0<this.length&&this.clear(),_.isArray(a)&&(this.import(a),this.totalLength=this.length))},loadOr:function(a,d){this.local||this.isLoading()||(this.isLoaded()?a&&a.call(d||this):this.load())},addNextPage:function(){!this.local&&this.length<this.totalLength&&this.load({start:this.length,limit:this.pageSize},!0)},loadNextPage:function(){this.local||(this.start+=this.pageSize,this.load())},loadPrevPage:function(){this.local||(this.start-=this.pageSize,this.load())},getRecordId:function(a){return a instanceof
MetaphorJs.data.Record?a.getId():a[this.model.getStoreProp("load","id")]||null},processRawDataItem:function(a){if(a instanceof MetaphorJs.data.Record||this.model.isPlain())return a;var d=this.model.type,c=this.getRecordId(a),b;c&&(b=MetaphorJs.data.Model.getFromCache(d,c));b||(b=MetaphorJs.create(d,c,a,{model:this.model,standalone:!1}));return b},bindRecord:function(a,d){d[a]("change",this.onRecordChange,this);d[a]("destroy",this.onRecordDestroy,this);d[a]("dirtychange",this.onRecordDirtyChange,this);
return d},onRecordDirtyChange:function(a){this.trigger("update",this,a)},onRecordChange:function(a,d,c,b){this.trigger("update",this,a)},onRecordDestroy:function(a){this.remove(a)},add:function(a,d,c){if(this.filtered)throw Error("Cannot add to filtered store");if("string"!=typeof a&&"number"!=typeof a){d=a;if(_.isArray(d)){if(!d.length)return;a=this.length;for(var b=0,e=d.length;b<e;b++)d[b]=this.processRawDataItem(d[b]),this.add(this.getRecordId(d[b]),d[b],!0);c||this.trigger("add",a,d);return}d=
this.processRawDataItem(d);a=this.getRecordId(d)}if("undefined"!=typeof a&&null!==a){if("undefined"!=typeof this.map[a]){this.replace(a,d);return}this.map[a]=d}this.length++;this.items.push(d);this.keys.push(a);d instanceof MetaphorJs.data.Record&&(d.attachStore(this),this.bindRecord("on",d));c||this.trigger("add",this.length-1,[d])},removeAt:function(a){if(a<this.length&&0<=a){this.length--;var d=this.items[a];this.items.splice(a,1);var c=this.keys[a];"undefined"!=typeof c&&delete this.map[c];this.keys.splice(a,
1);this.trigger("remove",d,c);return d instanceof MetaphorJs.data.Record?(this.bindRecord("un",d),d.detachStore(this),null):d}return!1},insert:function(a,d,c,b){if(this.filtered)throw Error("Cannot insert into filtered store");2==arguments.length&&(c=arguments[1],d=this.getRecordId(c));c=this.processRawDataItem(c);this.containsId(d)&&(this.suspendAllEvents(),this.removeId(d),this.resumeAllEvents());if(a>=this.length)return this.add(d,c,b);this.length++;this.items.splice(a,0,c);"undefined"!=typeof d&&
null!==d&&(this.map[d]=c);this.keys.splice(a,0,d);c instanceof MetaphorJs.data.Record&&(c.attachStore(this),this.bindRecord("on",c));b||this.trigger("add",a,[c]);return c},replace:function(a,d){var c,b;1==arguments.length&&(d=arguments[0],a=this.getRecordId(d));d=this.processRawDataItem(d);c=this.map[a];if("undefined"==typeof a||null===a||"undefined"==typeof c)return this.add(a,d);c instanceof MetaphorJs.data.Record&&(this.bindRecord("un",c),c.detachStore(this));b=this.indexOfId(a);this.items[b]=
d;this.map[a]=d;this.trigger("replace",a,c,d);return d},remove:function(a){return this.removeAt(this.indexOf(a))},removeId:function(a){return this.removeAt(this.indexOfId(a))},contains:function(a){return-1!=this.indexOf(a)},containsId:function(a){return"undefined"!=typeof this.map[a]},clear:function(){var a=this.getRange();this.clearFilter(!0);this._reset();this.trigger("clear",a)},reset:function(){this._reset()},_reset:function(a){var d,c;if(!a)for(a=0,d=this.items.length;a<d;a++)c=this.items[a],
c instanceof MetaphorJs.data.Record&&(this.bindRecord("un",c),c.detachStore(this));this.totalLength=this.length=this.start=0;this.items=[];this.keys=[];this.map={};this.loaded=this.local},filter:function(a,d,c){this.filtered&&this.clearFilter(!0);this.filtered=!0;this.filterFn=a;this.filterScope=d;this.filterParams=c;this.trigger("beforefilter",this);this.suspendAllEvents();this.filterBackup={length:this.length,items:this.items,keys:this.keys,map:this.map};this._reset(!0);a=this.filterBackup.keys;
d=this.filterBackup.items;c=0;for(var b=d.length;c<b;c++)this._filterRecord(d[c],a[c])&&(this.items.push(d[c]),this.keys.push(a[c]),this.length++,this.map[a[c]]=d[c]);this.resumeAllEvents();this.trigger("filter",this)},_filterRecord:function(a,b){return this.filtered&&this.filterFn.call(this.filterScope,a,b,this.filterParams)},clearFilter:function(a){this.filtered&&(a||this.trigger("beforeclearfilter",this),this.suspendAllEvents(),this.filtered=!1,this._reset(!0),this.length=this.filterBackup.length,
this.items=this.filterBackup.items,this.keys=this.filterBackup.keys,this.map=this.filterBackup.map,this.filterBackup=null,this.resumeAllEvents(),a||this.trigger("clearfilter",this))},getAt:function(a){return this.items[a]||null},getById:function(a){return this.map[a]||null},indexOf:function(a){return this.items.indexOf(a)},indexOfId:function(a){return this.keys.indexOf(a)},each:function(a,b){var c=[].concat(this.items);b=b||window;for(var e=0,f=c.length;e<f&&!1!==a.call(b,c[e],e,f);e++);},eachId:function(a,
b){b=b||window;for(var c=0,e=this.keys.length;c<e;c++)a.call(b,this.keys[c],this.items[c],c,e)},collect:function(a){var b=[],c=!this.model.isPlain();this.each(function(e){(e=c?e.get(a):e[a])&&b.push(e)});return b},first:function(){return this.items[0]},last:function(){return this.items[this.length-1]},getRange:function(a,b){var c=this.items;if(1>c.length)return[];a=a||0;b=Math.min("undefined"==typeof b||null===b?this.length-1:b,this.length-1);var e,f=[];if(a<=b)for(e=a;e<=b;e++)f[f.length]=c[e];else for(e=
a;e>=b;e--)f[f.length]=c[e];return f},findBy:function(a,b,c){a=this.findIndexBy(a,b,c);return-1==a?null:this.getAt(a)},findIndexBy:function(a,b,c){b=b||this;var e=this.keys,f=this.items;c=c||0;for(var h=f.length;c<h;c++)if(a.call(b,f[c],e[c]))return c;return-1},find:function(a,b,c){var e=!this.model.isPlain(),f;return this.findIndexBy(function(h){f=e?h.get(a):h[a];return c?f===b:f==b},this)},findExact:function(a,b){return this.find(a,b,!0)},findBySet:function(a){var b=null,c,e;this.each(function(f){c=
!0;for(e in a)if(a[e]!=f[e]){c=!1;break}if(c)return b=f,!1});return b},destroy:function(){delete e[this.id];this.trigger("destroy",this);this.removeAllListeners("clear");this.clear();this.supr()}},{createFromSelect:function(a){var b=[];a=a.options;for(var c=0,e=a.length;c<e;c++){var f=a[c],h=(f.hasAttribute?f.hasAttribute("value"):f.getAttributeNode("value").specified)?f.value:f.text;b.push([h,f.text])}a=MetaphorJs.create("MetaphorJs.data.Store",{server:{load:{id:0}}});a.loadArray(b);return a},lookupStore:function(a){return e[a]||
null}})})();MetaphorJs.define("MetaphorJs.data.Record","MetaphorJs.cmp.Observable",{id:null,data:null,orig:null,modified:null,loaded:!1,dirty:!1,destroyed:!1,model:null,standalone:!0,stores:null,initialize:function(b,e,a){var d=arguments.length;1==d?(a=b,e=b=null):2==d&&(a=e,e=null);this.orig={};this.stores=[];this.modified={};this.supr(a);"string"==typeof this.model?this.model=MetaphorJs.create(this.model):MetaphorJs.is(this.model,"MetaphorJs.data.Model")||(this.model=MetaphorJs.create("MetaphorJs.data.Model",
this.model));this.id=b;e?this.import(e):this.load();"MetaphorJs.data.Record"!=this.getClass()&&MetaphorJs.data.Model.addToCache(this)},isLoaded:function(){return this.loaded},isStandalone:function(){return this.standalone},isDirty:function(){return this.dirty},attachStore:function(b){b=b.getId();-1==this.stores.indexOf(b)&&this.stores.push(b)},detachStore:function(b){b=b.getId();var e;this.destroyed||-1==(e=this.stores.indexOf(b))||(this.stores.splice(e,1),0!=this.stores.length||this.standalone||
this.destroy())},setDirty:function(b){this.dirty!=b&&(this.dirty=b?!0:!1,this.trigger("dirtychange",this,b))},import:function(b){var e={},a;if(b){for(a in b)e[a]=this.model.restoreField(this,a,b[a]);this.data=e}this.orig=$.extend({},this.data);this.modified={};this.loaded=!0;this.setDirty(!1)},storeData:function(b){var e={},a;for(a in b)e[a]=this.model.storeField(this,a,b[a]);return e},getId:function(){return this.id},getData:function(){return $.extend({},this.data)},getChanged:function(){return $.extend({},
this.modified)},isChanged:function(b){return this.modified[b]||!1},get:function(b){return this.data[b]},setId:function(b){!this.id&&b&&(this.id=b)},set:function(b,e){var a=this.data[b];e=this.model.restoreField(this,b,e);this.data[b]=e;a!=e&&(this.modified[b]=!0,this.setDirty(!0),this.trigger("change",this,b,e,a),this.trigger("change-"+b,this,b,e,a))},revert:function(){this.dirty&&(this.data=$.extend({},this.orig),this.modified={},this.setDirty(!1))},load:function(){var b=this;b.trigger("beforeload",
b);return b.model.loadRecord(b.id).then(function(e,a){b.setId(e);b.import(a);b.trigger("load",b)},function(){b.trigger("failedload",b)})},save:function(){var b=this;b.trigger("beforesave",b);return b.model.saveRecord(b).then(function(e,a){b.setId(e);b.import(a);b.trigger("save",b)},function(){b.trigger("failedsave",b)})},delete:function(){var b=this;b.trigger("beforedelete",b);return b.model.deleteRecord(b).then(function(){b.trigger("delete",b);b.destroy()},function(){b.trigger("faileddelete",b)})},
destroy:function(){this.destroyed||(this.destroyed=!0,this.trigger("destroy",this),this.stores=this.model=this.modified=this.orig=this.data=null,MetaphorJs.data.Model.removeFromCache(this.getClass(),this.id),this.supr())}});MetaphorJs.define("MetaphorJs.cmp.DataList","MetaphorJs.cmp.Component",{store:null,destroyStore:!0,elList:null,listSelector:null,itemSelector:null,itemTpl:null,addClearfix:!1,emptyText:"",emptyCls:null,continuousScroll:!1,continuousOffset:50,continuousTmt:null,continuousTime:300,continuousSelector:null,elContinuous:null,initComponent:function(){this.checkWindowScrollDelegate=MetaphorJs.fn.delegate(this.checkWindowScroll,this);this.onWindowScrollDelegate=MetaphorJs.fn.delegate(this.onWindowScroll,
this);this.initStore();this.supr()},initStore:function(){this.setStoreEvents("on")},setStoreEvents:function(b){var e=this.store;e&&(e[b]("beforeload",this.onBeforeStoreLoad,this),e[b]("load",this.onStoreLoad,this),e[b]("filter",this.onStoreFilter,this),e[b]("clearfilter",this.onStoreClearFilter,this),e[b]("add",this.onStoreAdd,this),e[b]("replace",this.onStoreReplace,this),e[b]("remove",this.onStoreRemove,this),e[b]("clear",this.onStoreClear,this))},getStore:function(){return this.store},afterRender:function(){var b=
this.id;this.elList||(this.elList=null===this.listSelector?this.el:this.listSelector?$(this.listSelector,this.dom):$("#"+b+"-list"));this.supr();if(this.store.isLoaded())this.onStoreLoad();this.itemSelector&&this.elList.delegate(this.itemSelector,"click",MetaphorJs.fn.delegate(this.onRowClick,this));this.continuousScroll&&$(window).bind("scroll",this.onWindowScrollDelegate);this.continuousSelector&&(this.elContinuous=$(this.continuousSelector,this.dom))},onRowClick:function(b){var e=this.getItemByEvent(b),
a=this.getRecordByEl(e);a&&(this.onItemClick(b,a,e),this.trigger("itemclick",a,e))},onItemClick:MetaphorJs.emptyFn,getItemByEvent:function(b){b=$(b.target);b.is(this.itemSelector)||(b=b.parents(this.itemSelector).eq(0));return b},getElById:function(b){b=$("[data-id="+b+"]",this.dom);return b.length?b:null},getRecordByEl:function(b){b=b.attr("data-id");return this.store.getById(b)},getRecordByEvent:function(b){if((b=this.getItemByEvent(b))&&b.length)return this.getRecordByEl(b)},toggleEmpty:function(){var b=
this.store,e=0==b.getLength();this.el[e?"addClass":"removeClass"](this.emptyCls);e&&this.emptyText&&this.elList.html(this.emptyText);if(this.elContinuous)this.elContinuous[b.getLength()>=b.getTotalLength()?"hide":"show"]()},onBeforeStoreLoad:MetaphorJs.emptyFn,onStoreLoad:function(){this.rendered&&(this.renderAll(),this.toggleEmpty())},onStoreFilter:function(){this.renderAll();this.toggleEmpty()},onStoreClearFilter:function(){this.renderAll();this.toggleEmpty()},onStoreAdd:function(b,e){var a=this.renderRows(b,
e),d;0==b?(this.elList.html(a),this.addClearfix&&this.elList.append(this.addClearfix)):(d=$(this.itemSelector+":eq("+(b-1)+")",this.elList.get(0)),d.after(a));this.toggleEmpty()},onStoreReplace:function(b,e,a){e=this.getElById(b);b=this.store.indexOf(b);a=this.renderRows(b,[a]);e.replaceWith(a)},onStoreRemove:function(b,e){var a=this.getElById(e);a&&a.remove();this.toggleEmpty()},onStoreClear:function(){this.elList.html("");this.toggleEmpty()},renderAll:function(){var b=this.store;0<b.getLength()?
this.elList.html(this.renderRows(0,b.getRange())):this.toggleEmpty()},renderRows:function(b,e){var a="",d,c;d=0;for(c=e.length;d<c;d++)a+=this.renderOneRow(b+d,e[d]);return a},renderOneRow:function(b,e){var a=this.itemTpl,d=e instanceof MetaphorJs.data.Record?e.getData():e,c;if(a)for(c in d)for(;-1!=a.indexOf("{"+c+"}");)a=a.replace("{"+c+"}",d[c]);return a},onWindowScroll:function(){this.continuousTmt||(this.continuousTmt=window.setTimeout(this.checkWindowScrollDelegate,this.continuousTime))},checkWindowScroll:function(){var b=
this,e=b.store;if(!e||e.isLocal()||e.getLength()>=e.getTotalLength())b.continuousTmt=null;else{var a=$(window),e=a.height(),a=a.scrollTop();Math.max(document.documentElement.scrollHeight,document.body.scrollHeight)-(e+a)<=b.continuousOffset?b.store.addNextPage(function(){b.continuousTmt=null}):b.continuousTmt=null}},onDestroy:function(){this.store&&(this.destroyStore?this.store.destroy():this.setStoreEvents("un"),this.store=null);$(window).unbind("scroll",this.onWindowScrollDelegate);this.supr()}});
}());