<!DOCTYPE html>
<html>
<head>


    <script src="numeral.min.js"></script>
    <script src="moment.min.js"></script>
    <script src="../src/lib/Polyfill.js"></script>
    <script src="../src/MetaphorJs.js"></script>
    <script src="../src/lib/Common.js"></script>
    <script src="../src/lib/Selector.js"></script>
    <script src="../src/lib/Value.js"></script>
    <script src="../src/lib/Event.js"></script>
    <script src="../src/lib/Input.js"></script>

    <script src="../../metaphorjs-namespace/metaphorjs.namespace.js"></script>
    <script src="../../metaphorjs-class/metaphorjs.class.js"></script>
    <script src="../../metaphorjs-promise/metaphorjs.promise.js"></script>
    <script src="../../metaphorjs-observable/metaphorjs.observable.js"></script>
    <script src="../../metaphorjs-watchable/metaphorjs.watchable.js"></script>
    <script src="../../metaphorjs-ajax/metaphorjs.ajax.js"></script>
    <script src="../../metaphorjs-history/metaphorjs.history.js"></script>
    <script src="../../metaphorjs-validator/metaphorjs.validator.js"></script>

    <script src="../src/lib/Text.js"></script>
    <script src="../src/lib/Provider.js"></script>
    <script src="../src/cmp/Base.js"></script>
    <script src="../../metaphorjs-model/src/Model.js"></script>
    <script src="../../metaphorjs-model/src/Record.js"></script>
    <script src="../../metaphorjs-model/src/Store.js"></script>

    <script src="../src/lib/Animate.js"></script>
    <script src="../src/view/Scope.js"></script>
    <script src="../src/view/Browser.js"></script>
    <script src="../src/view/TextRenderer.js"></script>
    <script src="../src/view/Renderer.js"></script>
    <script src="../src/view/Template.js"></script>
    <script src="../src/cmp/Component.js"></script>
    <script src="../src/cmp/App.js"></script>
    <script src="../src/cmp/View.js"></script>
    <script src="../src/view/Attribute.js"></script>
    <script src="../src/view/Filter.js"></script>
    <script src="../src/view/Validator.js"></script>

    <script src="../../metaphorjs-dialog/metaphorjs.dialog.js"></script>
    <script src="../src/cmp/Dialog.js"></script>



    <style>


        body {
            padding-bottom: 100px;
        }

        #render {
            overflow: hidden;
        }

        mjs-template {
            display:none;
        }

        .cls1 {
            font-size: 32px;
        }

        .cls2 {
            color: #008200;
        }

        .cls3 {
            text-decoration: line-through;
        }

        .article {
            width: 50%;
            float: left;
        }


        .mjs-show, .mjs-hide {
            -webkit-transition:  opacity 0.4s;
            -moz-transition:  opacity 0.4s;
            -o-transition:   opacity 0.4s;
            transition:  opacity 0.4s;
        }

        .mjs-show {
            opacity: 0;
        }
        .mjs-hide {
            opacity: 1;
        }
        .mjs-show-active {
            opacity: 1;
        }
        .mjs-hide-active {
            opacity: 0;
        }


        .mjs-enter-active, .mjs-leave-active {
            -webkit-transition: -webkit-transform 0.4s, opacity 0.4s;
            -moz-transition: -moz-transform 0.4s, opacity 0.4s;
            -o-transition:   -o-transform: 0.4s, opacity 0.4s;
            transition:  transform 0.4s, opacity 0.4s;
        }

        .mjs-enter {
            opacity: 0;
            -webkit-transform: translateY(100px);
            -moz-transform: translateY(100px);
            transform: translateY(100px);
        }
        .mjs-leave {
            opacity: 1;
            -webkit-transform: translateY(0);
            -moz-transform: translateY(0);
            transform: translateY(0);
        }
        .mjs-enter-active {
            opacity: 1;
            -webkit-transform: translateY(0);
            -moz-transform: translateY(0);
            transform: translateY(0);
        }
        .mjs-leave-active {
            opacity: 0;
            -webkit-transform: translateY(100px);
            -moz-transform: translateY(100px);
            transform: translateY(100px);
        }


        .error {
            border: 4px solid #800000;
        }
        .error-add {
            border: 1px solid #800000;
            border-width: 1px;
        }
        .error-add-active {
            border-width: 4px;
            -webkit-transition:  border-width 0.4s;
            -moz-transition:  border-width 0.4s;
            -o-transition:   border-width 0.4s;
            transition:  border-width 0.4s;
        }


        .dialog {

            max-width: 400px;
            position: absolute;
            box-shadow: rgba(0,0,0,0.2) 2px 2px 10px;
            background-color: #000;
            padding: 20px;
            color: #fff;

        }

        .dialog a {
            color: #fff;
        }

    </style>
</head>
<body>

    <script type="text/mjs-template" id="test-template">
        <p>{{.text}}</p>
        <p>{{.subtext}}</p>
        <p>{{.a}}</p>
        <div mjs-transclude></div>
    </script>

    <script type="text/mjs-template" id="cmp1-template">
        <h2>{{.title}}</h2>
        <div mjs-transclude></div>
    </script>

    <script type="text/mjs-template" id="a+b">
        <p>a + b = {{ .$root.a + .$root.b }}</p>
    </script>

    <script type="text/mjs-template" id="a*b">
        <p>a * b = {{ .$root.a * .$root.b }}</p>
    </script>


    <div id="render" mjs-init=".header = 'new header'; .text = 'new text'">

        <h1>App 1</h1>

        <div class="header">{{.header}}</div>
        <div class="article">

            {{.rootText | uppercase }}

            <div class="menu" mjs-bind-html=".subtext"></div>
            <p>
                Here is some {{ .text }} <span> and {{.subtext}}</span> <sup>{{ .text }}</sup>
                <sub> {{ .bool ? "true" : "false" }}</sub>
                <span>{{ .num | numeral:'0,00.0000'}}</span>
                <span>{{ .date | moment:'LLL'}}</span>
            </p>

            <hr>

            <p mjs-class="{cls1: .bool, cls2: .a == 0}" mjs-animate>
                {{ .a + .b }}
            </p>

            <hr>

            <a href="http://{{.text}}.com" mjs-click=".bool = !.bool">{{.subtext | limitTo:.a}}</a><br>
            <input mjs-bind=".a * .b"/>
            <input mjs-model=".a" type="number" mjs-input-type="number"/>
            <br>

            <input type="checkbox" mjs-model="bool"/>
            <input type="radio" name="r" value="header" mjs-model="header"/>1
            <label><input type="radio" name="r" value="header1"/>2</label>
            <input type="radio" name="r" value="header2"/>3
            <br><br>

            <select mjs-model=".a" mjs-input-type="number">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
            <br><br>
            <hr>


            <input mjs-model=".newItem" mjs-enter="if (.newItem) {.list.push({bool: false, txt: .newItem}); .newItem = '';}"/>
            <input type="button"
                   mjs-disabled="!.newItem"
                   mjs-click=".list.push({bool: false, txt: .newItem}); .newItem = '';"
                   value="Add item"/>

            <ul mjs-show=".bool" mjs-animate>
                <li mjs-each="item in .list | filter:.listFilter | sortBy:'txt':.sortBy" mjs-animate>
                    <label mjs-class="{cls3: .item.bool}">
                        <input type="checkbox" mjs-model=".item.bool"/>
                        {{.$index}} -
                        {{.item.txt}} -
                        {{ .$first ? "first" : "" }} -
                        {{ .$last ? "last" : "" }} -
                        {{ .$even ? "even" : "" }} -
                        {{ .$odd ? "odd" : "" }}
                    </label>
                    <a href="#" mjs-click=".$parent.list.splice(.$index,1);">x</a>
                </li>
            </ul>

            <input mjs-model=".listFilter" placeholder="Search"/>
            <a href="#" mjs-click=".sortBy='asc'">asc</a>
            <a href="#" mjs-click=".sortBy='desc'">desc</a>

            <hr>

            <div mjs-include="test-template" mjs-hide="!.bool" mjs-animate>
                <p>transcluded text</p>
            </div>

            <hr>

            <div mjs-include="test-template"></div>

            <hr>

            <form name="myForm" mjs-validate mjs-class="{error: .myForm.$invalid}" mjs-animate>
                <h2>Test form</h2>
                <div>
                    <input name="field1" data-validate-required mjs-class="{error: .myForm.field1.$invalid}"/>
                </div>
                <div mjs-class="{error: .myForm.radio1.$invalid}">
                    <label><input type="radio" name="radio1" value="1" data-validate-required/> -- 1</label>
                    <label><input type="radio" name="radio1" value="2"/> -- 2</label>
                    <label><input type="radio" name="radio1" value="3"/> -- 3</label>
                </div>
                <div>
                    <input type="submit" value="Submit"/>
                    <input type="reset" value="Reset"/>
                </div>
            </form>


            <hr mjs-init='.sep = "/\\n|,/"'>

            <label><input type="radio" name="sep" value="/\n|,/" mjs-model=".sep"/> /\n|,/</label>
            <label><input type="radio" name="sep" value="/\n/"/> /\n/</label>
            <label><input type="radio" name="sep" value=","/> ,</label><br>

            <textarea mjs-model="toList:.sep >> .dynamicList | fromList"></textarea>

            <ul>
                <li mjs-each="item in .dynamicList" mjs-recursive>
                    {{.item}}
                </li>
            </ul>

        </div>

        <div class="article">

            <div mjs-include="template.html">
                <p>Transcluded text</p>
            </div>

            <hr>

            <div mjs-cmp="Test.MyComponent as ctrl">
                <p mjs-cmp-prop="para">Component's transcluded text + {{ .$root.a}}</p>
                <a href="#" mjs-click=".ctrl.reverse()">reverse</a> |
                <a href="#" mjs-click=".ctrl.createNew()">create new component on existing element</a> |
                <a href="#" mjs-click=".ctrl.createRender()">create new component and render to</a> |
                <a href="#" mjs-click=".ctrl.createDialog()">create new dialog</a>
                <br><br>
                <button mjs-click=".store.load()">Load store</button>
                <button mjs-click=".store.clear()">Clear store</button>
                <ul>
                    <li mjs-each-in-store="item in .store" mjs-animate>
                        {{ .item.get("name") }}
                    </li>
                </ul>
            </div>

            <hr>

            <div id="myComponent1" mjs-cmp="Test.MyComponent as ctrl">
                <p>This is another instance with deferred value: {{ .deferred }}</p>
            </div>

            <hr>

            <div mjs-cmp="Test.TplComponent as ctrl" mjs-if=".$parent.bool" mjs-animate>
                <h2>{{ .title }}</h2>
                mjs-include change template:
                <a href="#" mjs-click=".tpl='a+b'">a + b</a> |
                <a href="#" mjs-click=".tpl='a*b'">a * b</a>

                <div mjs-include=".tpl" mjs-animate></div>
            </div>

            <hr>

            <div mjs-cmp="Test.StringTemplate"></div>

            <hr>

            <div mjs-cmp="Test.ChangeTemplate">
                mjs-cmp change template:
                <a href="#" mjs-click=".tpl=.tpl1">tpl1</a> |
                <a href="#" mjs-click=".tpl=.tpl2">tpl2</a>
            </div>

            <hr>

            <div mjs-view="Test.MyView" mjs-animate>
                <p>This component controller by View</p>
            </div>

            <hr>

            <div id="newComponent">
                Dynamically created component on existing element will go here
            </div>

            <hr>

            <div id="renderToComponent">
                Dynamically created component with renderTo will go here
            </div>

            <hr>

            pushUrl: <a href="/1">/1</a> |
            <a href="/2">/2</a> |
            <a href="/3">/3</a> |
            <a href="http://www.kuindji.com">outside</a><br><br>

            <hr>

            <div mjs-ignore>
                This element is ignored by renderer: {{ .$root.a }}
            </div>

            <hr>

            <div mjs-view mjs-view-cmp=".viewCmp" mjs-view-default="Test.ViewComponent1">
                <p>
                    change cmp:
                    <a href="#" mjs-click=".$parent.viewCmp = 'Test.ViewComponent1'">Cmp1</a> |
                    <a href="#" mjs-click=".$parent.viewCmp = 'Test.ViewComponent2'">Cmp2</a>
                </p>
            </div>
        </div>
    </div>

    <hr>


    <div mjs-app="Test.MyApp2" mjs-init=".a = 100" mjs-cloak>
        <h1>Another app</h1>
        <p>a = {{.a}}</p>
        <p>resolved = {{.resolved}}</p>
        <p>The following utilizes recursive text renderer:</p>
        <p mjs-recursive>This is level 1: {{.level1}}</p>
        <p>
            <a href="#" mjs-click=".changeLevel2()">Change level 2</a> |
            <a href="#" mjs-click=".increaseB()">Increase B</a>
        </p>
        <p>using normal expression with filter: {{ 'key' | l}}</p>
        <p>{{.b}} {{ 'plr' | p:.b}}</p>
        <p mjs-recursive>{{'subkey1' | l}}</p>
        <p>using lang expression: {[ key ]} {{.b}} {[ plr | p:.b]}</p>
        <p mjs-bind-html=".linkified | linkify"></p>
        <p><input type="number" mjs-input-type="number" mjs-model=".people"/></p>
        <p mjs-recursive>{[ viewing | p:.people]}</p>
    </div>

    <script>
        MetaphorJs.d("Test.MyApp2", "MetaphorJs.cmp.App", {

            initApp: function(node, scope, someValue) {

                var self    = this;
                var level2Inx = 0;
                var level2  = [
                    '(level 3 value: {{.b}})',
                    '(level 3 value: {{.c}})'
                ];

                self.scope.resolved = someValue;

                self.scope.level1   = '[ and here comes level 2: {{.level2}} ]';
                self.scope.level2   = level2[level2Inx];

                self.scope.b        = 1;
                self.scope.c        = "variable c";

                self.scope.changeLevel2 = function(inx) {
                    level2Inx = level2Inx == 0 ? 1 : 0;
                    self.scope.level2 = level2[level2Inx];
                };

                self.scope.increaseB = function() {
                    self.scope.b++;
                };

                self.scope.linkified = 'Linkified text aaa http://www.kuindji.com bbb';

                self.scope.people = 0;

                self.lang.setLocale("ru");
                self.lang.set("key", "text value");
                self.lang.set("plr", ["котик", "котика", "котиков"]);
                self.lang.set("subkey1", 'subkey: {{\'subkey2\' | l}}');
                self.lang.set('subkey2', 'text value');

                self.lang.set("viewing", {
                    '0': 'Nobody is viewing',
                    '1': 'One person is viewing',
                    '2': 'Two people are viewing',
                    other: '{{.people}} people are viewing',
                    negative: ""
                });
            }

        },{
            inject: ['$node', '$scope', 'someValue'],
            resolve: {
                someValue: function() {
                    var p = new MetaphorJs.lib.Promise;
                    setTimeout(function(){
                        p.resolve((new Date).getTime());
                    }, 100);
                    return p;
                }
            }
        });


        MetaphorJs.onReady(function(){

            MetaphorJs.d("Test.MyView", "MetaphorJs.cmp.View", {

                route: [
                    {
                        reg: /^\/1$/,
                        cmp: "Test.MyComponent"
                    },
                    {
                        reg: /^\/2\/(\d+)$/,
                        params: ["param"],
                        cmp: "Test.MyComponent2"
                    },
                    {
                        reg: /^\/2$/,
                        cmp: "Test.MyComponent2"
                    },
                    {
                        reg: /^\/3$/,
                        template: "a+b"
                    }
                ]
            });

            MetaphorJs.d("Test.MyRecord", "MetaphorJs.data.Record", {});

            MetaphorJs.d("Test.MyComponent", "MetaphorJs.cmp.Component", {

                initComponent: function() {

                    var self    = this;

                    self.scope.title = "My Component" + (new Date).getTime();

                    var model   = new MetaphorJs.data.Model({
                        type: "Test.MyRecord",
                        id: "id",
                        data: "record",
                        total: "total",
                        store: {
                            load: "/metaphorjs/test/data.json"
                        }
                    });

                    self.scope.store = new MetaphorJs.data.Store({
                        model: model
                    });

                    self.scope.deferred = self.deferred;
                },

                afterRender: function() {

                    if (this.para && window.console && window.console.log) {
                        console.log("got child property 'para': ", this.para);
                    }
                },

                reverse: function() {
                    var title   = this.scope.title;
                    this.scope.title    = title.split("").reverse().join('');
                },

                createNew: function() {

                    var node    = document.getElementById("newComponent");
                    MetaphorJs.resolveComponent("Test.DynamicComponent", {}, this.scope, node);
                },

                createRender: function() {

                    var to  = document.getElementById("renderToComponent");
                    MetaphorJs.resolveComponent("Test.DynamicComponent", {renderTo: to}, this.scope);
                },

                createDialog: function() {


                    try {
                        var dialog = new MetaphorJs.cmp.Dialog({
                            dialogCfg: {
                                cls: {
                                     dialog: "dialog"
                                },
                                position: "wc",
                                show: {
                                      animate: true
                                },
                                hide: {
                                      destroy: true
                                }
                            },
                            as: "dlg",
                            scope: this.scope,
                            template: '<p>This is a dialog. <a href="#" mjs-click=".dlg.hide()">close</a></p>'
                        });
                        dialog.show();
                    }
                    catch(e) {
                        MetaphorJs.error(e)
                    }

                },

                loadStore: function() {
                    this.scope.store.load().done(function(){
                        this.scope.$check();
                    }, this);
                }
            }, {
                template: "cmp1-template",
                resolve: {
                    deferred: ['$node', '$scope', 'test', function(node, scope, test) {

                        return new MetaphorJs.lib.Promise(function(resolve, reject){
                            setTimeout(function(){
                                resolve((new Date).getTime());
                            }, 1000);
                        });
                    }]
                }
            });

            MetaphorJs.d("Test.MyComponent2", "MetaphorJs.cmp.Component", {

                template: 'cmp1-template',

                initComponent: function(cfg, param) {
                    var self    = this;

                    if (cfg.param) {
                        alert("received param: " + cfg.param);
                    }
                    self.scope.title = "My Component2 " + (new Date).getTime();
                }
            });

            MetaphorJs.d("Test.TplComponent", "MetaphorJs.cmp.Component", {

                initComponent: function() {

                    var self    = this;

                    self.scope.title= "Tpl Component";
                    self.scope.tpl  = "a+b";

                    self.scope.$app.onAvailable("myComponent1").done(function(cmp){
                        if (window.console && window.console.log) {
                            console.log("on available myComponent1");
                        }
                    });
                }

            });

            MetaphorJs.d("Test.StringTemplate", "MetaphorJs.cmp.Component", {}, {
                template: '<p>This template is inlined in components definition ({{.$root.a}})</p>'
            });

            MetaphorJs.d("Test.DynamicComponent", "MetaphorJs.cmp.Component", {}, {
                template: '<p>This component was created dynamically</p><div mjs-transclude></div>'
            });

            MetaphorJs.d("Test.ChangeTemplate", "MetaphorJs.cmp.Component", {

                template: '.tpl',

                initComponent: function() {

                    var scope = this.scope;

                    scope.tpl1 = '<p>Template 1</p><div mjs-transclude></div>';
                    scope.tpl2 = '<p>Template 2</p><div mjs-transclude></div>';

                    scope.tpl = scope.tpl1;
                }
            });

            MetaphorJs.d("Test.ViewComponent1", "MetaphorJs.cmp.Component", {
                template: '<p>View template 1</p><div mjs-transclude></div>'
            });
            MetaphorJs.d("Test.ViewComponent2", "MetaphorJs.cmp.Component", {
                template: '<p>View template 2</p><div mjs-transclude></div>'
            });




            var dataObj     = {
                header: "header",
                text: "text",
                subtext: "subtext",
                rootText: "root text",
                a: 1,
                b: 2,
                bool: true,
                newItem: "",
                date: new Date,
                num: 10000,
                list: [
                    {bool: true, txt: "item 1"},
                    {bool: false, txt: "item 2"},
                    {bool: false, txt: "item 3"}
                ]
            };
            var start  = (new Date).getTime();

            //console.profile();
            MetaphorJs.app(document.getElementById("render"), null, dataObj)
            .done(function(app){
                app.value("test", "123");
                app.run();
            });

            //console.profileEnd();

            var end  = (new Date).getTime();

            if (window.console) {
                console.log("render time: ", end - start);
            }



        });


    </script>




</body>
</html>
